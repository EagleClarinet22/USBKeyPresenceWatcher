name: Repository Validation Pipeline

on:
  pull_request:
    paths:
      - "**/*.ps1"
      - "**/*.psm1"
      - "**/*.psd1"
      - "**/*.xml"
      - ".gitattributes"
      - "internal-docs/PSScriptAnalyzerSettings.psd1"
  push:
    paths:
      - "**/*.ps1"
      - "**/*.psm1"
      - "**/*.psd1"
      - "**/*.xml"
      - ".gitattributes"
      - "internal-docs/PSScriptAnalyzerSettings.psd1"

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-repository:
    runs-on: ubuntu-latest

    steps:
      #####################################################################
      # Step 1 ‚Äî Checkout Repo
      #####################################################################
      - name: Checkout repository
        uses: actions/checkout@v4

      #####################################################################
      # Step 2 ‚Äî Print computed .gitattributes rules
      #####################################################################
      - name: Show effective .gitattributes rules
        run: git check-attr --all -- . | sort

      #####################################################################
      # Step 3 ‚Äî Validate XML encoding (must be UTF-16 LE/BE)
      #####################################################################
      - name: Validate XML encoding requirements
        run: |
          xml_files=$(git ls-files "*.xml" || true)

          if [[ -z "$xml_files" ]]; then
            echo "No XML files found."
            exit 0
          fi

          for f in $xml_files; do
            attr=$(git check-attr text -- "$f" | awk '{print $3}')
            encoding=$(file -bi "$f" | sed 's/.*charset=//')

            echo "Checking $f (text=$attr, encoding=$encoding)"

            if [[ "$attr" != "unset" ]]; then
              echo "::error file=$f::Expected '-text' in .gitattributes, but was '$attr'."
              exit 1
            fi

            if [[ "$encoding" != "utf-16le" && "$encoding" != "utf-16be" ]]; then
              echo "::warning file=$f::XML is not UTF-16 ($encoding)."
              echo "::warning file=$f::Fix in VS Code: Save with Encoding ‚Üí UTF-16 LE."
              echo "::error file=$f::Invalid XML encoding."
              exit 1
            fi
          done

      #####################################################################
      # Step 4 ‚Äî Validate XML structure
      #####################################################################
      - name: Install xmllint (libxml2-utils)
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils

      - name: Validate XML structure with xmllint
        run: |
          for f in $(git ls-files "*.xml"); do
            echo "Validating $f structure..."
            xmllint --noout "$f"
            if [[ $? -ne 0 ]]; then
              echo "::error file=$f::Malformed XML."
              exit 1
            fi
            echo "‚úî $f structure OK"
          done

      #####################################################################
      # Step 5 ‚Äî Validate PowerShell line endings (CRLF)
      #####################################################################
      - name: Validate PowerShell CRLF line endings
        run: |
          ps_files=$(git ls-files "*.ps1" "*.psm1" "*.psd1" || true)

          for f in $ps_files; do
            if file "$f" | grep -q "CRLF"; then
              echo "‚úî $f uses CRLF"
            else
              echo "::error file=$f::PowerShell files must use CRLF line endings."
              exit 1
            fi
          done

      #####################################################################
      # Step 6 ‚Äî Validate Markdown LF line endings
      #####################################################################
      - name: Validate Markdown LF line endings
        run: |
          for f in $(git ls-files "*.md" || true); do
            if file "$f" | grep -q "CRLF"; then
              echo "::error file=$f::Markdown must use LF line endings."
              exit 1
            fi
            echo "‚úî $f uses LF"
          done

      #####################################################################
      # Step 7 ‚Äî Run PSScriptAnalyzer
      # - Custom settings file
      # - Markdown summary
      # - PR comment
      # - Fail only on errors
      #####################################################################
      - name: Run PSScriptAnalyzer with summary + PR comment
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "Running PSScriptAnalyzer..."

          $results = Invoke-ScriptAnalyzer -Path . -Recurse -Settings internal-docs/PSScriptAnalyzerSettings.psd1

          if ($results) {
            $results | Format-Table
          } else {
            Write-Host "No PSScriptAnalyzer issues found."
          }

          $errors = $results | Where-Object Severity -eq 'Error'
          $warnings = $results | Where-Object Severity -eq 'Warning'


          #################################################################
          # Build Markdown Summary
          #################################################################
          $summary = "# üîç PSScriptAnalyzer Results`n"

          if ($errors) {
            $summary += "## ‚ùå Errors (Build Failed)`n"
            foreach ($e in $errors) {
              $summary += "- **$($e.RuleName)** ‚Äî $($e.Message) *(File: `$($e.ScriptPath)`, Line: $($e.Line))*`n"
            }
          }

          if ($warnings) {
            $summary += "`n## ‚ö† Warnings (Non-blocking)`n"
            foreach ($w in $warnings) {
              $summary += "- **$($w.RuleName)** ‚Äî $($w.Message) *(File: `$($w.ScriptPath)`, Line: $($w.Line))*`n"
            }
          }

          if (-not $errors -and -not $warnings) {
            $summary += "‚úî No issues found!"
          }

          # Add to GitHub Summary UI
          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8


          #################################################################
          # Post PR Comment
          #################################################################
          if ("${{ github.event_name }}" -eq "pull_request") {
            Write-Host "Posting PR comment..."
            $body = $summary.Replace("`n", "\n")
            gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments -f body="$body"
          }


          #################################################################
          # Fail ONLY on errors
          #################################################################
          if ($errors) {
            Write-Error "PSScriptAnalyzer errors detected."
            exit 1
          }

          Write-Host "‚úî No errors ‚Äî warnings allowed."

      #####################################################################
      # Step 8 ‚Äî Completed
      #####################################################################
      - name: Validation complete
        run: echo "üéâ Repository validation succeeded."
